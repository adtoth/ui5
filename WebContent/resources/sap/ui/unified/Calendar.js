/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2014 SAP AG or an SAP affiliate company. 
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
jQuery.sap.declare("sap.ui.unified.Calendar");jQuery.sap.require("sap.ui.unified.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.ui.unified.Calendar",{metadata:{publicMethods:["focusDate"],library:"sap.ui.unified",properties:{"intervalSelection":{type:"boolean",group:"Misc",defaultValue:false},"singleSelection":{type:"boolean",group:"Misc",defaultValue:true}},aggregations:{"selectedDates":{type:"sap.ui.unified.DateRange",multiple:true,singularName:"selectedDate"}},events:{"select":{},"cancel":{}}}});sap.ui.unified.Calendar.M_EVENTS={'select':'select','cancel':'cancel'};jQuery.sap.require("sap.ui.core.LocaleData");jQuery.sap.require("sap.ui.core.delegate.ItemNavigation");jQuery.sap.require("sap.ui.model.type.Date");(function(){sap.ui.unified.Calendar.prototype.init=function(){this._mouseMoveProxy=jQuery.proxy(this._handleMouseMove,this);this._iMode=0;this._oFormatYyyymmdd=sap.ui.core.format.DateFormat.getInstance({pattern:"yyyyMMdd"})};sap.ui.unified.Calendar.prototype.onAfterRendering=function(){var t=this;d(t);p(t)};sap.ui.unified.Calendar.prototype.invalidate=function(O){var t=this;g(t);if(!O||!(O instanceof sap.ui.unified.DateRange)){sap.ui.core.Control.prototype.invalidate.apply(this,arguments)}else{if(this.getDomRef()&&this._iMode==0){e(t)}}};sap.ui.unified.Calendar.prototype.setLocale=function(L){if(this._sLocale!=L){this._sLocale=L;this._oLocaleData=undefined;this.invalidate()}return this};sap.ui.unified.Calendar.prototype.getLocale=function(){if(!this._sLocale){this._sLocale=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString()}return this._sLocale};sap.ui.unified.Calendar.prototype._getFocusedDate=function(){if(!this._oFocusedDate){var t=this;g(t)}return this._oFocusedDate};sap.ui.unified.Calendar.prototype._setFocusedDate=function(D){this._oFocusedDate=new Date(D.getTime());this._oFocusedDate.setHours(0,0,0,0)};sap.ui.unified.Calendar.prototype.focusDate=function(D){if(D&&(!this._oFocusedDate||this._oFocusedDate.getTime()!=D.getTime())){this._setFocusedDate(D);if(this.getDomRef()&&this._iMode==0){var t=this;e(t)}}};sap.ui.unified.Calendar.prototype.setPopupMode=function(P){this._bPoupupMode=P};sap.ui.unified.Calendar.prototype._getLocaleData=function(){if(!this._oLocaleData){var L=this.getLocale();var i=new sap.ui.core.Locale(L);this._oLocaleData=sap.ui.core.LocaleData.getInstance(i)}return this._oLocaleData};sap.ui.unified.Calendar.prototype.onclick=function(E){if(E.isMarked("delayedMouseEvent")){return}var t=this;var F=this._getFocusedDate();if(jQuery.sap.containsOrEquals(this.getDomRef("next"),E.target)){switch(this._iMode){case 0:F.setMonth(F.getMonth()+1,1);e(t);break;case 1:F.setFullYear(F.getFullYear()+1);this.$("year").text(F.getFullYear());break;case 2:o(t,true,this._oItemNavigation.getFocusedIndex());break}}else if(jQuery.sap.containsOrEquals(this.getDomRef("prev"),E.target)){switch(this._iMode){case 0:F.setDate(1);F.setDate(F.getDate()-1);e(t);break;case 1:F.setFullYear(F.getFullYear()-1);this.$("year").text(F.getFullYear());break;case 2:o(t,false,this._oItemNavigation.getFocusedIndex());break}}else if(E.target.id==this.getId()+"-month"){if(this._iMode!=1){h(t)}else{j(t)}}else if(E.target.id==this.getId()+"-year"){if(this._iMode!=2){l(t)}else{m(t)}}else if(E.target.id==this.getId()+"-cancel"){this.onsapescape(E)}};sap.ui.unified.Calendar.prototype._handleMouseMove=function(E){if(!this.$().is(":visible")){jQuery(window.document).unbind('mousemove',this._mouseMoveProxy);this._bMouseMove=undefined}var t=jQuery(E.target);if(t.hasClass("sapUiCalDayNum")){t=t.parent()}if(t.hasClass("sapUiCalDay")){var F=this._getFocusedDate();var O=new Date(F.getTime());F=this._oFormatYyyymmdd.parse(t.attr("data-sap-day"));this._setFocusedDate(F);if(F.getTime()!=O.getTime()){var i=this;if(t.hasClass("sapUiCalDayOtherMonth")){e(i)}else{f(i,new Date(F.getTime()),false,true);this._bMoveChange=true}}}};sap.ui.unified.Calendar.prototype.onmouseup=function(E){if(this._bMouseMove){jQuery(window.document).unbind('mousemove',this._mouseMoveProxy);this._bMouseMove=undefined;var F=this._getFocusedDate();var D=this.$("days").children(".sapUiCalDay");for(var i=0;i<D.length;i++){var $=jQuery(D[i]);if(!$.hasClass("sapUiCalDayOtherMonth")){if($.attr("data-sap-day")==this._oFormatYyyymmdd.format(F)){$.focus();break}}}if(this._bMoveChange){var t=this;f(t,new Date(F.getTime()));this._bMoveChange=false;q(t)}}};sap.ui.unified.Calendar.prototype.onsapselect=function(E){var t=this;var i=0;switch(this._iMode){case 0:if(jQuery.sap.containsOrEquals(this.getDomRef("days"),E.target)){f(t,new Date(this._getFocusedDate().getTime()));q(t)}break;case 1:if(jQuery.sap.containsOrEquals(this.getDomRef("months"),E.target)){i=this._oItemNavigation.getFocusedIndex();k(t,i)}break;case 2:if(jQuery.sap.containsOrEquals(this.getDomRef("years"),E.target)){i=this._oItemNavigation.getFocusedIndex();n(t,i)}break}E.stopPropagation();E.preventDefault()};sap.ui.unified.Calendar.prototype.onsapselectmodifiers=function(E){this.onsapselect(E)};sap.ui.unified.Calendar.prototype.onsapescape=function(E){var t=this;switch(this._iMode){case 0:this.fireCancel();break;case 1:j(t);break;case 2:m(t);break}};sap.ui.unified.Calendar.prototype.onsappageupmodifiers=function(E){var F=this._getFocusedDate();var t=this;var y=F.getFullYear();F.setFullYear(y-1);e(t);E.preventDefault()};sap.ui.unified.Calendar.prototype.onsappagedownmodifiers=function(E){var F=this._getFocusedDate();var t=this;var y=F.getFullYear();F.setFullYear(y+1);e(t);E.preventDefault()};sap.ui.unified.Calendar.prototype.onsaptabnext=function(E){if(jQuery.sap.containsOrEquals(this.getDomRef("days"),E.target)||jQuery.sap.containsOrEquals(this.getDomRef("months"),E.target)||jQuery.sap.containsOrEquals(this.getDomRef("years"),E.target)){jQuery.sap.focus(this.getDomRef("month"));if(!this._bPoupupMode){jQuery(this._oItemNavigation.getItemDomRefs()[this._oItemNavigation.getFocusedIndex()]).attr("tabindex","-1")}E.preventDefault()}else if(E.target.id==this.getId()+"-month"){jQuery.sap.focus(this.getDomRef("year"));E.preventDefault()}};sap.ui.unified.Calendar.prototype.onsaptabprevious=function(E){if(E.target.id==this.getId()+"-month"){this._oItemNavigation.focusItem(this._oItemNavigation.getFocusedIndex());E.preventDefault()}else if(E.target.id==this.getId()+"-year"){jQuery.sap.focus(this.getDomRef("month"));E.preventDefault()}};sap.ui.unified.Calendar.prototype._checkDateSelected=function(D){var s=0;var S=this.getSelectedDates();for(var i=0;i<S.length;i++){var r=S[i];var t=r.getStartDate();var u=undefined;var v=0;if(t){u=new Date(t.getTime());u.setHours(0,0,0,0);v=u.getTime()}var E=undefined;var w=0;var T=D.getTime();if(this.getIntervalSelection()){t=r.getEndDate();if(t){E=new Date(t.getTime());E.setHours(0,0,0,0);w=E.getTime()}}if(T==v&&!E){s=1;break}else if(T==v&&E){s=2;if(E&&T==w){s=5}break}else if(E&&T==w){s=3;break}else if(E&&T>v&&T<w){s=4;break}if(this.getSingleSelection()){break}}return s};function _(C){var I=C.getParameter("index");var E=C.getParameter("event");if(!E){return}var t=this;if(this._iMode==0){var D=this.$("days").children(".sapUiCalDay");var F=this._getFocusedDate();var $=jQuery(D[I]);if($.hasClass("sapUiCalDayOtherMonth")){if(E.type=="saphomemodifiers"&&(E.metaKey||E.ctrlKey)){F.setDate(1);for(var i=0;i<D.length;i++){var r=jQuery(D[i]);if(this._oFormatYyyymmdd.parse(r.attr("data-sap-day")).getDate()==1){this._oItemNavigation.focusItem(i);break}}}else if(E.type=="sapendmodifiers"&&(E.metaKey||E.ctrlKey)){for(var i=D.length-1;i>0;i--){var r=jQuery(D[i]);if(!r.hasClass("sapUiCalDayOtherMonth")){F=this._oFormatYyyymmdd.parse(r.attr("data-sap-day"));this._setFocusedDate(F);this._oItemNavigation.focusItem(i);break}}}else{F=this._oFormatYyyymmdd.parse($.attr("data-sap-day"));this._setFocusedDate(F);e(t)}}else{if(!jQuery(E.target).hasClass("sapUiCalWeekNum")){F=this._oFormatYyyymmdd.parse($.attr("data-sap-day"));this._setFocusedDate(F)}}}if(E.type=="mousedown"){b(t,E,F,I)}};function a(C){var i=C.getParameter("index");var E=C.getParameter("event");if(!E){return}if(E.type=="mousedown"){var t=this;var F=this._getFocusedDate();b(t,E,F,i)}};function b(t,E,F,i){switch(t._iMode){case 0:f(t,new Date(F.getTime()),E.shiftKey);q(t);if(t.getIntervalSelection()&&t.$().is(":visible")){jQuery(window.document).bind('mousemove',t._mouseMoveProxy);t._bMouseMove=true}break;case 1:k(t,i);break;case 2:n(t,i);break}E.preventDefault();E.setMark("cancelAutoClose")};function c(C){var i=C.getParameter("index");var E=C.getParameter("event");var M=0;var F=this._getFocusedDate();if(E.type){var t=this;switch(this._iMode){case 0:switch(E.type){case"sapnext":case"sapnextmodifieres":if(E.keyCode==jQuery.sap.KeyCodes.ARROW_DOWN){F.setDate(F.getDate()+7)}else{F.setDate(F.getDate()+1)}break;case"sapprevious":case"sappreviousmodifieres":if(E.keyCode==jQuery.sap.KeyCodes.ARROW_UP){F.setDate(F.getDate()-7)}else{F.setDate(F.getDate()-1)}break;case"sappagedown":M=F.getMonth()+1;F.setMonth(M);if(M%12!=F.getMonth()){while(M!=F.getMonth()){F.setDate(F.getDate()-1)}}break;case"sappageup":M=F.getMonth()-1;F.setMonth(M);if(M<0){M=11}if(M!=F.getMonth()){while(M!=F.getMonth()){F.setDate(F.getDate()-1)}}break;default:break}e(t);break;case 1:break;case 2:switch(E.type){case"sapnext":case"sapnextmodifieres":if(E.keyCode==jQuery.sap.KeyCodes.ARROW_DOWN){o(t,true,this._oItemNavigation.getFocusedIndex()-16)}else{o(t,true,0)}break;case"sapprevious":case"sappreviousmodifieres":if(E.keyCode==jQuery.sap.KeyCodes.ARROW_UP){o(t,false,16+this._oItemNavigation.getFocusedIndex())}else{o(t,false,19)}break;case"sappagedown":o(t,true,this._oItemNavigation.getFocusedIndex());break;case"sappageup":o(t,false,this._oItemNavigation.getFocusedIndex());break;default:break}break}}};function d(t){var D=t._getFocusedDate();var y=t._oFormatYyyymmdd.format(D);var r=[];var I=0;var C=0;var N=false;var s=true;switch(t._iMode){case 0:var u=D.getDate();r=t.$("days").children(".sapUiCalDay");for(var i=0;i<r.length;i++){var $=jQuery(r[i]);if($.attr("data-sap-day")==y){I=i}}C=7;N=true;s=false;break;case 1:r=t.$("months").children(".sapUiCalMonth");I=D.getMonth();C=3;break;case 2:r=t.$("years").children(".sapUiCalYear");I=10;C=4;N=true;s=false;break}if(!t._oItemNavigation){t._oItemNavigation=new sap.ui.core.delegate.ItemNavigation();t._oItemNavigation.attachEvent(sap.ui.core.delegate.ItemNavigation.Events.AfterFocus,_,t);t._oItemNavigation.attachEvent(sap.ui.core.delegate.ItemNavigation.Events.FocusAgain,a,t);t._oItemNavigation.attachEvent(sap.ui.core.delegate.ItemNavigation.Events.BorderReached,c,t);t.addDelegate(t._oItemNavigation);t._oItemNavigation.setHomeEndColumnMode(true,true)}t._oItemNavigation.setRootDomRef(t.getDomRef());t._oItemNavigation.setItemDomRefs(r);t._oItemNavigation.setCycling(s);t._oItemNavigation.setColumns(C,N);t._oItemNavigation.setFocusedIndex(I);t._oItemNavigation.setPageSize(r.length)};function e(t){var D=t._getFocusedDate();var C=t.$("days");if(C.length>0){var r=sap.ui.getCore().createRenderManager();t.getRenderer().renderDays(r,t,D);r.flush(C[0]);r.destroy()}t.fireEvent("_renderMonth",{days:C.children(".sapUiCalDay").length});var M=[];if(t._bLongMonth||!t._bNamesLengthChecked){M=t._getLocaleData().getMonthsStandAlone("wide")}else{M=t._getLocaleData().getMonthsStandAlone("abbreviated")}t.$("month").text(M[D.getMonth()]);t.$("year").text(D.getFullYear());d(t);t._oItemNavigation.focusItem(t._oItemNavigation.getFocusedIndex())};function f(t,D,I,M){var s=t.getSelectedDates();var r;var F=t._getFocusedDate();var u=t.$("days").children(".sapUiCalDay");if(t.getSingleSelection()){var S=undefined;if(s.length>0){r=s[0];S=r.getStartDate();if(S){S=new Date(S.getTime());S.setHours(0,0,0,0)}}else{r=new sap.ui.unified.DateRange();t.addAggregation("selectedDates",r,true)}if(t.getIntervalSelection()&&(!r.getEndDate()||M)&&S){var E=undefined;if(D.getTime()<S.getTime()){E=S;S=new Date(D.getTime());if(!M){r.setProperty("startDate",S,true);r.setProperty("endDate",E,true)}}else if(D.getTime()>=S.getTime()){E=new Date(D.getTime());if(!M){r.setProperty("endDate",E,true)}}var v;var w=0;for(var i=0;i<u.length;i++){var $=jQuery(u[i]);v=t._oFormatYyyymmdd.parse($.attr("data-sap-day"));if(v.getTime()==S.getTime()){$.addClass("sapUiCalDaySelStart");$.addClass("sapUiCalDaySel");if(E&&v.getTime()==E.getTime()){$.addClass("sapUiCalDaySelEnd")}}else if(E&&v.getTime()>S.getTime()&&v.getTime()<E.getTime()){$.addClass("sapUiCalDaySel");$.addClass("sapUiCalDaySelBetween")}else if(E&&v.getTime()==E.getTime()){$.addClass("sapUiCalDaySelEnd");$.addClass("sapUiCalDaySel")}else{if($.hasClass("sapUiCalDaySel")){$.removeClass("sapUiCalDaySel")}if($.hasClass("sapUiCalDaySelStart")){$.removeClass("sapUiCalDaySelStart")}else if($.hasClass("sapUiCalDaySelBetween")){$.removeClass("sapUiCalDaySelBetween")}else if($.hasClass("sapUiCalDaySelEnd")){$.removeClass("sapUiCalDaySelEnd")}}}}else{var y=t._oFormatYyyymmdd.format(D);for(var i=0;i<u.length;i++){var $=jQuery(u[i]);if(!$.hasClass("sapUiCalDayOtherMonth")&&$.attr("data-sap-day")==y){$.addClass("sapUiCalDaySel")}else if($.hasClass("sapUiCalDaySel")){$.removeClass("sapUiCalDaySel")}if($.hasClass("sapUiCalDaySelStart")){$.removeClass("sapUiCalDaySelStart")}else if($.hasClass("sapUiCalDaySelBetween")){$.removeClass("sapUiCalDaySelBetween")}else if($.hasClass("sapUiCalDaySelEnd")){$.removeClass("sapUiCalDaySelEnd")}}r.setProperty("startDate",new Date(D.getTime()),true);r.setProperty("endDate",undefined,true)}}else{if(t.getIntervalSelection()){throw new Error("Calender don't support multiple interval selection")}else{var x=t._checkDateSelected(D);if(x>0){for(var i=0;i<s.length;i++){if(s[i].getStartDate()&&D.getTime()==s[i].getStartDate().getTime()){t.removeAggregation("selectedDates",i,true);break}}}else{r=new sap.ui.unified.DateRange({startDate:new Date(D.getTime())});t.addAggregation("selectedDates",r,true)}var y=t._oFormatYyyymmdd.format(D);for(var i=0;i<u.length;i++){var $=jQuery(u[i]);if(!$.hasClass("sapUiCalDayOtherMonth")&&$.attr("data-sap-day")==y){if(x>0){$.removeClass("sapUiCalDaySel")}else{$.addClass("sapUiCalDaySel")}}}}}};function g(t){var s=t.getSelectedDates();if(s&&s[0]&&s[0].getStartDate()){t._oFocusedDate=new Date(s[0].getStartDate().getTime())}else{t._oFocusedDate=new Date()}t._oFocusedDate.setHours(0,0,0,0)};function h(t){if(t._iMode==2){m(t)}var D=t._getFocusedDate();var r=sap.ui.getCore().createRenderManager();var C=t.$();t.getRenderer().renderMonthPicker(r,t,D);r.flush(C[0],false,true);r.destroy();t._iMode=1;jQuery(t._oItemNavigation.getItemDomRefs()[t._oItemNavigation.getFocusedIndex()]).attr("tabindex","-1");d(t);jQuery.sap.focus(t._oItemNavigation.getItemDomRefs()[t._oItemNavigation.getFocusedIndex()])};function j(t){t.$("months").remove();t._iMode=0;d(t);jQuery.sap.focus(t._oItemNavigation.getItemDomRefs()[t._oItemNavigation.getFocusedIndex()])};function k(t,M){var F=t._getFocusedDate();F.setMonth(M);if(M!=F.getMonth()){var D=F.getDate();F.setDate(0)}e(t);j(t)};function l(t){if(t._iMode==1){j(t)}var D=t._getFocusedDate();var r=sap.ui.getCore().createRenderManager();var C=t.$();t.getRenderer().renderYearPicker(r,t,D);r.flush(C[0],false,true);r.destroy();var i=t.$("days").children(".sapUiCalDay");if(i.length==28){t.$("years").addClass("sapUiCalYearNoTop")}t._iMode=2;jQuery(t._oItemNavigation.getItemDomRefs()[t._oItemNavigation.getFocusedIndex()]).attr("tabindex","-1");d(t);jQuery.sap.focus(t._oItemNavigation.getItemDomRefs()[t._oItemNavigation.getFocusedIndex()])};function m(t){t.$("years").remove();t._iMode=0;d(t);jQuery.sap.focus(t._oItemNavigation.getItemDomRefs()[t._oItemNavigation.getFocusedIndex()])};function n(t,i){var F=t._getFocusedDate();var D=t.$("years").children(".sapUiCalYear");var y=jQuery(D[i]).text();F.setFullYear(y);e(t);m(t)};function o(t,F,s){var D=t.$("years").children(".sapUiCalYear");var r=parseInt(jQuery(D[0]).text());var u=t._getFocusedDate();var C=u.getFullYear().toString();if(F){r=r+20}else{r=r-20}var y=r;for(var i=0;i<D.length;i++){var $=jQuery(D[i]);$.attr("id",t.getId()+"-y"+y);$.text(y);if($.hasClass("sapUiCalYearSel")&&$.text()!=C){$.removeClass("sapUiCalYearSel")}else if(!$.hasClass("sapUiCalYearSel")&&$.text()==C){$.addClass("sapUiCalYearSel")}y++}t._oItemNavigation.focusItem(s)};function p(t){if(!t._bNamesLengthChecked){var w=t.$().children(".sapUiCalWH");var T=false;for(var i=0;i<w.length;i++){var W=w[i];if(W.clientWidth<W.scrollWidth){T=true;break}}if(T){t._bLongWeekDays=false;var L=t._getLocaleData();var F=L.getFirstDayOfWeek();var D=L.getDaysStandAlone("narrow");for(i=0;i<D.length;i++){var W=w[i];jQuery(W).text(D[(i+F)%7])}}else{t._bLongWeekDays=true}h(t);var M=t.$("months").children();T=false;for(i=0;i<M.length;i++){var r=M[i];if(r.clientWidth<r.scrollWidth){T=true;break}}if(T){t._bLongMonth=false;if(!L){L=t._getLocaleData()}var s=L.getMonthsStandAlone("abbreviated");var u=t._getFocusedDate();t.$("month").text(s[u.getMonth()])}else{t._bLongMonth=true}j(t);t._bNamesLengthChecked=true}};function q(t){if(t._bMouseMove){jQuery(window.document).unbind('mousemove',t._mouseMoveProxy);t._bMouseMove=undefined}t.fireSelect()}}());
